// Generated by CoffeeScript 1.7.1
(function() {
  var checkSite, checkSites, fs, path, sitesPath, storage;

  path = require('path');

  fs = require('fs');

  sitesPath = path.join(__dirname, '../config', 'sites.json');

  sitesPath = path.join(__dirname, '../config', 'sites.json');

  storage = require("./storage");

  checkSite = function(site, errorCallback) {
    return setTimeout(function() {
      var request, res;
      request = require('sync-request');
      try {
        res = request("GET", site.url);
      } catch (_error) {
        res = {};
        res.statusCode = 404;
      }
      if (res.statusCode !== site.statusCode && site.statusCode === 200) {
        if (typeof errorCallback === "function") {
          errorCallback(site);
        }
      }
      site.statusCode = res.statusCode;
      return storage.push("sites", site);
    }, 0);
  };

  checkSites = function(errorCallback) {
    var site, sites, _i, _len, _results;
    console.log("check sites...");
    sites = storage.get("sites");
    if (!sites || sites.length === 0) {
      sites = JSON.parse(fs.readFileSync(sitesPath)).sites;
    }
    storage.set("sites", []);
    _results = [];
    for (_i = 0, _len = sites.length; _i < _len; _i++) {
      site = sites[_i];
      _results.push(checkSite(site, errorCallback));
    }
    return _results;
  };

  module.exports = checkSites;

}).call(this);
